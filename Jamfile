import testing ;

rule suppress-warnings ( properties * )
{
    local vc-ver = [
        MATCH "^<toolset-msvc:version>([0-9]+)[.]" : $(properties)
    ] ;
    if $(vc-ver) && $(vc-ver) >= 8
    {
        return <cxxflags>-wd4819 <cxxflags>-wd4996 ;
    }
}

project mgit
    : requirements
      <link>shared:<define>BOOST_TEST_DYN_LINK=1
      <target-os>cygwin:<linkflags>-liconv
      <library>/boost//headers
      <conditional>@suppress-warnings
      <define>BOOST_ALL_NO_LIB=1
      <include>.
    : usage-requirements
      <define>BOOST_TEST_NO_AUTO_LINK=1
    : build-dir bin
    ;

lib gitobjs
    :
    [ GLOB . : *.cc ]
    compat/mingw.cc
    :
    <link>static
    ;

local test_sources = [ GLOB testsuite : *.cc ] ;
local test_names = $(test_sources:B) ;
for name in $(test_names)
{
    run testsuite/$(name).cc
        gitobjs
        :
        :
        :
        <library>/boost/system//boost_system
        <library>/boost/test//boost_unit_test_framework
        :
        $(name)
        ;
    explicit $(name) ;
}

alias test : $(test_names) ;
